{% extends 'marketplace/base.html' %}
{% load bootstrap3 %}

{% block head %}
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/javascript">
    $(function() {
        $('[data-toggle="tooltip"]').tooltip()
    })
    window.MathJax = ({
        elements: ["model-desc"],
        tex2jax: {
            inlineMath: [ ['$', '$'], [ "\\(", "\\)" ] ],
            processEscapes: true
        }
    });
</script>
<script type="text/javascript">
    var addComment = function(comment) {
        var commentHtml = $([
            "<div class='comment well'>",
            "    <div class='detail-container'>",
            "        <div class='user'>",
            "            " + comment['user'],
            "        </div>",
            "        <div class='time'>",
            "            " + comment['time'],
            "        </div>",
            "    </div>",
            "    <div class='content'>",
            "        " + comment['content'],
            "    </div>",
            "    <div class='actions'>",
            "        <a class='btn btn-danger delete-comment-btn' data-toggle='tooltip' data-placement='right' title='Delete comment' data-comment-id='" + comment['id'] + "' href='#comment-section'><span class='glyphicon glyphicon-remove'></span></a>",
            "    </div>",
            "</div>"
        ].join('\n'));

        var container = $('#comment-container');
        var firstChild = $(container.children()[0])
        if (firstChild.is('p')) {
            container.html('');
        }
        container.append(commentHtml);
    };

    var removeComment = function(commentWell) {
        var commentContainer = $(commentWell.parent());
        commentWell.html('<p>Comment deleted.</p>');
        commentWell.delay(1500).fadeOut(400, function() {
            $(this).remove();
            if (commentContainer.find('div').length === 0) {
                commentContainer.html($("<p>No comments yet.</p>"));
            }
        });
    };

    var lastPoll = new Date();
    var fetchNewComments = function() {
        $.ajax({
            url: "{% url 'get_new_comments' %}",
            type: "GET",
            data: {
                model: "{{ model.id }}",
                since: lastPoll.getTime()
            },

            success: function(json) {
                var comments = json['comments'];
                for (var i in comments) {
                    addComment(comments[i]);
                }
            },

            error: function(xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
        lastPoll = new Date();
    };
    setInterval(fetchNewComments, 30000);
</script>
{% if model.example_data_json != "[]" %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.2/Chart.bundle.min.js"></script>
{% endif %}

{% endblock head %}

{% block content %}

<ol class="breadcrumb">
    <li><a href="{% url 'index' %}">Categories</a></li>
    {% if model.category %}
        <li><a href="{% url 'view_category' slug=model.category.slug %}">{{ model.category.name }}</a></li>
    {% else %}
    <li><a href="{% url 'view_category' %}">All Models</a></li>
    {% endif %}
    <li><a href="{% url 'detail' model_id=model.id %}">{{ model.name }}</a></li>
</ol>

<h1>{{ model.name }}</h1>

<h2>Description:</h2>
<div id="model-desc" class="container">
    <p>
        {{ model.description|linebreaks }}
    </p>
    {% if model.example_data_x and model.example_data_x %}
        <h2>Example Data:</h2>
        <canvas class="center-block" id="example-graph" width="500" height="500"></canvas>
        <script type="text/javascript">
            Chart.defaults.global.legend.display = false;
            var ctx = $("#example-graph");
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '{{ model.name }}',
                        fill: false,
                        borderColor: "rgba(0,0,255,1)",
                        data: {{ model.example_data_json }},
                    }]
                },
                options: {
                    scales: {
                        xAxes: [{
                            type: 'logarithmic',
                            position: 'bottom',
                            scaleLabel: { display: true, labelString: 'log(Q) [A^-1]' },
                            gridLines: { display: false }
                        }],
                        yAxes: [{
                            type: 'logarithmic',
                            scaleLabel: { display: true, labelString: 'log(I) [cm^-1]' },
                            gridLines: { display: false }
                        }]
                    },
                    responsive: false,
                }

            });
        </script>
    {% endif %}

</div>


<h2>Details:</h2>
<table class="table">
    <tr>
        <td><b>Created By</b></td>
        <td><a href="{% url 'profile' user_id=model.owner.id %}">{{ model.owner.username }}</a></td>
    </tr>
    <tr>
        <td><b>Uploaded</b></td>
        <td>{{ model.upload_date }}</td>
    </tr>
    <tr>
        <td><b>Category</b></td>
        <td>{{ model.category|default_if_none:"None" }}</td>
    </tr>
    <tr>
        <td><b>Verified</b></td>
        <td>
            {% if model.verified %}
                <span class="text-success">{% bootstrap_icon 'ok' %} Verified by {{ model.verified_by.first_name }} {{ model.verified_by.last_name }} on {{ model.verfied_date|date:"d M Y" }}</span>
            {% else %}
                <span class="text-danger">{% bootstrap_icon 'remove' %} This model has not been verified by a member of the SasView team</span>
            {% endif %}
        </td>
    </tr>

    <tr>
        <td><b>Files</b></td>
        <td>
            {% if files %}
            {% for f in files %}
                <a href="{% url 'show_file' file_id=f.id %}">{{ f.name }}</a><br />
            {% endfor %}

            {% else %}
            No files uploaded yet.
            {% endif %}
        </td>
    </tr>
</table>

{% if request.user == model.owner %}
<div>
<a href="{% url 'edit' model_id=model.id %}" class="btn btn-primary btn-edit">{% bootstrap_icon "pencil" %} Edit Details</a>
<a href="{% url 'edit_files' model_id=model.id %}" class="btn btn-primary btn-edit">{% bootstrap_icon "file" %} Edit Files</a>
<button type="button" class="btn btn-danger delete-btn btn-edit" data-toggle="modal" data-target="#delModal">
  {% bootstrap_icon 'remove-circle' %} Delete
</button>
</div>
<!-- Modal -->
<div class="modal fade" id="delModal" tabindex="-1" role="dialog" aria-labelledby="delModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="delModalLabel">Delete Model</h4>
      </div>
      <div class="modal-body" id="del-modal-content">
        Are you sure you want to delete this model?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <a type="button" class="btn btn-danger" href="#" id="modal-del-btn">Delete</a>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
    $('.delete-btn').click(function(event) {
        var modelName = "{{ model.name }}";
        var deleteUrl = "{% url 'delete' model_id=model.id %}";
        $('#del-modal-content').text("Are you sure you want to delete " + modelName + "?");
        $('#modal-del-btn').attr('href', deleteUrl);
    });
</script>
{% endif %}

{% if request.user.is_staff %}
<div>
    {% if model.verified == False %}
        <a href="{% url 'verify' model_id=model.id %}" class="btn btn-success">{% bootstrap_icon 'ok' %} Verify</a>
    {% else %}
        <a href="{% url 'verify' model_id=model.id %}" class="btn btn-danger">{% bootstrap_icon 'remove' %} Un-Verify</a>
    {% endif %}
</div>
{% endif %}

<h3>Comments:</h3>
<div id="comment-container">
{% if comments %}
    {% for comment in comments %}
        <div class="comment well">
            <div class="detail-container">
                <div class="user">
                    {{ comment.user.username }}:
                </div>
                <div class="time">
                    {{ comment.time|date:"D d M Y" }} at {{ comment.time|date:"H:i" }}
                </div>
            </div>
            <div class="content">
                {{ comment.content }}
            </div>
            {% if comment.user == request.user %}
            <div class="actions">
                    <a class="btn btn-danger delete-comment-btn" data-toggle="tooltip" data-placement="right" title="Delete comment" data-comment-id="{{ comment.id }}" href="#comment-container">{% bootstrap_icon 'remove' %}</a>
            </div>
            {% endif %}
        </div>
    {% endfor %}
    <script type="text/javascript">
        $('#comment-container').on('click', '.actions .delete-comment-btn', function(event) {
            var button = $(event.toElement);
            if (!button.is('a')) button = button.parent();
            var comment_id = button.attr('data-comment-id');
            var csrfInput = $("{% csrf_token %}");
            $.ajax({
                url: "{% url 'delete_comment' %}",
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': csrfInput.attr('value'),
                    'comment_id': comment_id
                },

                success: function(json) {
                    if (json['success']) {
                        var commentWell = button.parent().parent();
                        removeComment(commentWell);
                    } else {
                        for (var i in json['errors']) {
                            var errmsg = json['errors'][i];
                            var errorAlert = $([
                                "<div class='alert alert-danger alert-dismissable'>",
                                "    <button type='button' class='close' data-dismiss='alert' aria-hidden='true'>x</button>",
                                "    " + errmsg,
                                "</div>"
                            ].join("\n"));
                            $($('.container')[1]).prepend(errorAlert);
                        }
                    }
                },

                error:function(xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        });
    </script>

{% else %}
    <p>
        No comments yet.
    </p>
{% endif %}
</div>

{% if request.user.is_authenticated %}
    <form class="form" id="comment-form">
        {% csrf_token %}
        {% bootstrap_form form %}
        {% buttons %}
            <button type="submit" class="btn btn-primary" id="post-comment">{% bootstrap_icon 'comment' %} Post Comment</button>
        {% endbuttons %}
    </form>
    <script type="text/javascript">
        $('#id_model').parent().hide();
        $('#post-comment').click(function(event) {
            fetchNewComments();
            event.preventDefault();
            var formGroup = $('#id_content').parent()
            // Trim whitespace
            var content = $('#id_content').val().replace(/^\s+|\s+$/g, '');
            if (content === '') {
                formGroup.addClass('has-error');
                formGroup.append($([
                    "<span class='help-block'>Please enter a comment.</span>"
                ].join('\n')));
                return;
            } else {
                formGroup.removeClass('has-error');
                formGroup.find('span').remove();
            }
            $.ajax({
                url: '{% url 'new_comment' %}',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': $('#comment-form input').attr('value'),
                    'content': $('#id_content').val(),
                    'model': {{ model.id }}
                },

                success: function(json) {
                    $('#id_content').val('');
                    // Error message
                    if (json['authenticated'] === false) {
                        console.log("User not authenticated");
                        var errorAlert = $([
                            "<div class='alert alert-danger alert-dismissable'>",
                            "    <button type='button' class='close' data-dismiss='alert' aria-hidden='true'>x</button>",
                            "    You must log in to post a comment.",
                            "</div>"
                        ].join("\n"));
                        $($('.container')[1]).prepend(errorAlert);
                        return;
                    } else if (json['errors'] !== undefined) {
                        var err_msg = json['errors']['content'][0]
                        if (err_msg !== undefined) {
                            formGroup.addClass('has-error');
                            formGroup.append($([
                                "<span class='help-block'>" + err_msg + "</span>"
                            ].join('\n')));
                        } else {
                            var errorAlert = $([
                                "<div class='alert alert-danger alert-dismissable'>",
                                "    <button type='button' class='close' data-dismiss='alert' aria-hidden='true'>x</button>",
                                "    Error posting comment.",
                                "</div>"
                            ].join("\n"));
                            $($('.container')[1]).prepend(errorAlert);
                        }
                        return;
                    }
                    // Comment posted
                    addComment(json);
                },
                error: function(xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        });
    </script>
{% else %}
    <p>
        Please log in to add a comment.
    </p>
{% endif %}



{% endblock content %}
